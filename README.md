なこリーダー
============

[きみも地下鉄運転士｜ゲームで学ぼう｜名古屋市交通局ハッチーキッズサイト](https://www.kids.kotsu.city.nagoya.jp/game/simulator/)

のスクリーンショットから

* 到着までの時間
* 停止位置目標までの残り距離
* 速度
* ノッチの位置

を読み取り、テキスト化する。

まわりの枠を含まない、ゲーム画面本体のみの画像が入力されることを仮定する。  
また、入力されるゲーム画面は、十分大きいウィンドウなどの中にある、縮小されていないものであることを仮定する。

認識ミスや認識失敗が起こりうるので、データの用途に応じて十分注意すること。

## 依存ライブラリ

Pillow (PIL) を使える状態にしておくこと。

[Basic Installation - Pillow (PIL Fork) 11.1.0 documentation](https://pillow.readthedocs.io/en/stable/installation/basic-installation.html)

## 使い方

### 情報を読み取る

```
python nako_reader.py [options] file [file...]
```

指定したファイルから情報を読み取り、標準出力に出力する。  
読み取れなかった場合は、エラーを標準エラー出力に出力する。

以下のオプションが使用できる。

* `--model ファイル名`：`model.json` のかわりに指定したファイルを設定ファイルとして使用する
* `--header`：標準出力の最初にデータの内容を表すヘッダを出力する
* `--serial`：1個のファイルを処理するのではなく、連番ファイルを処理する
* `--help`：ファイルの処理を行わず、ヘルプを出力する

連番ファイルの処理時は、指定されたファイル名から Python の `%` を用いて読み込むファイル名を生成する。  
連番は `1` から開始する。  
たとえば、`%03d` と書くと、連番をゼロ埋めして3桁 (以上) にした文字列に置換される。(1個のみ使用可能)

### 読み取った情報を整形する

```
python post_process.py [しきい値]
```

`nako_reader.py` が出力する情報を標準入力から読み取り、以下の加工をして標準出力に出力する。

* ファイル名を消去する
* 時刻をシンプルな秒単位に変換する
* (表示されている速度とは別に) 時刻と残り距離の差から計算した速度を追加する

しきい値を設定すると、時刻が前の時刻からしきい値 [秒] を超えて進んでいたり、(差にかかわらず) 戻っていたりするデータを無視する。

## 設定ファイル

`model.json` に、状態を読み取るための設定をJSONで記述する。

```
{
  "common": 共通設定
  "time": 時刻読み取り設定,
  "distance": 残り距離読み取り設定,
  "speed": 速度読み取り設定,
  "notch": ノッチ読み取り設定
  
}
```

### 共通設定

```
{
  "thresholds": 数値の配列,
  "number_table": オブジェクト
}
```

#### thresholds

二値化の際に用いるしきい値を表す数値の配列。  
グレースケール化の結果 (0～255) がこの値未満なら黒、以上なら白とみなす。  
最初の値から用い、うまく読み取れなければ次の値を試していく。  
「うまく読み取れない」とは、時刻・残り距離・速度のうち、読み取りに失敗したものがあることである。  
すべてのしきい値でうまく読み取れなかった場合、この画像の読み取りは失敗とみなす。

ノッチのみ読み取りに失敗した場合は、うまく読み取れなかったとみなさず、ノッチとして `?` を出力する。

#### number_table

7セグメントLED形式で数字を読み取る際に用いるフォントの情報を表すオブジェクト。  
キーを7セグメントLEDの点灯状況、値をその点灯状況に対応する文字列とする。  
点灯状況は、`a`・`b`・`c`・`d`・`e`・`f`・`g` のうち、点灯しているセグメントに対応する文字を、かつその文字のみをこの順で結合した文字列で表す。

### 時刻読み取り設定

```
{
  "putterns": パターンの配列
}
```

#### putterns

時刻を読み取るためのパターン (後述) の配列。  
最初の値から用い、最初に読み取りに成功したパターンによる読み取り結果を、時刻の読み取り結果とする。  
読み取りに成功したパターンが無い場合、読み取りは失敗とみなす。

### 残り距離読み取り設定

```
{
  "putterns": パターンの配列
}
```

#### putterns

残り距離を読み取るためのパターン (後述) の配列。  
最初の値から用い、最初に読み取りに成功したパターンによる読み取り結果を、残り距離の読み取り結果とする。  
読み取りに成功したパターンが無い場合、読み取りは失敗とみなす。

### 速度読み取り設定

```
{
  "putterns": パターンの配列
}
```

#### putterns

速度を読み取るためのパターン (後述) の配列。  
最初の値から用い、最初に読み取りに成功したパターンによる読み取り結果を、速度の読み取り結果とする。  
読み取りに成功したパターンが無い場合、読み取りは失敗とみなす。

### ノッチ読み取り設定

```
{
  "x": 数値,
  "settings": [
    {
      "name": 文字列,
      "ys": 数値の配列
    },
    ...
  ]
}
```

#### x

ノッチの判定のため色を読み取る場所のx座標を表す数値。全ての位置について共通で用いる。

#### settings

ノッチの位置の判定方法を表すオブジェクトの配列。

各オブジェクトは、以下のメンバを持つ。

* `name`：位置の名前
* `ys`：ノッチがこの位置のとき「白」である位置のy座標を表す数値の配列

`x` および `ys` で指定された位置のピクセルが全て「白」であるとき、この位置は「条件を満たす」という。  
`settings` で記述された位置のうち、ちょうど1個の位置が「条件を満たす」とき、ノッチの位置をそれだと判定する。  
「条件を満たす」位置が無かったり、複数ある場合は、読み取りに失敗したとみなす。

### パターン

パターンは、「7セグパターン」や「固定文字パターン」を要素とする配列で表す。  
読み取り結果は、最初は空文字列とする。  
この配列の前から順に画像に当てはめ、当てはまったら読み取り結果の末尾に対応する文字を追加し、読み取り結果を更新する。  
当てはまらなかったら、このパターンでの読み取りに失敗したとみなす。  
全ての要素が当てはまったら、読み取りに成功したとみなす。

#### 7セグパターン

```
{
  "type": "7seg",
  "segments": {
    "a": [数値, 数値],
    "b": [数値, 数値],
    "c": [数値, 数値],
    "d": [数値, 数値],
    "e": [数値, 数値],
    "f": [数値, 数値],
    "g": [数値, 数値]
  }
}
```

`segments` は、各セグメントの点灯状況を判定するための座標を `[x, y]` の配列で指定する。  
指定したピクセルが「白」ならば点灯、「黒」ならば消灯とみなす。

読み取った点灯状況を `commmon.number_table` に当てはめ、該当するキーがあればそのキーに対応する値を対応する文字として当てはまる。  
該当するキーがなければ、当てはまらない。

`segments` のかわりに、以下のように `xs` と `ys` で座標を表してもよい。

```
{
  "type": "7seg",
  "xs": [数値, 数値, 数値],
  "ys": [数値, 数値, 数値, 数値, 数値]
}
```

これらを指定した場合、`segments` を以下のように指定したのに相当する。  
ただし、`segments` が明示的に指定されている場合は、その指定を優先する。

```
{
  "a": [xs[1], ys[0]],
  "b": [xs[2], ys[1]],
  "c": [xs[2], ys[3]],
  "d": [xs[1], ys[4]],
  "e": [xs[0], ys[3]],
  "f": [xs[0], ys[1]],
  "g": [xs[1], ys[2]]
}
```

#### 固定文字パターン

```
{
  "type": "fixed",
  "char": 文字列,
  "whites": [[数値, 数値], ...],
  "blacks": [[数値, 数値], ...]
}
```

`char` には、このパターンに当てはまったときの対応する文字を表す。  

`whites` には、このパターンに当てはまるために「白」であるべきピクセルの座標の配列を指定する。  
`blacks` には、このパターンに当てはまるために「黒」であるべきピクセルの座標の配列を指定する。  
座標は `[x, y]` の形式で指定する。  
これらの条件に全て当てはまった場合、またその場合のみ、このパターンに当てはまったとみなす。
